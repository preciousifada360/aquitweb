$("#message-bar-holder").html("<div class=\"message-bar\" id=\"message\"><div class=\"message-home\"><div class=\"message-people-holder\" data-holder-type=\"messages\"><div class=\"message-header\"><span>Messages<\/span><div class=\"new-msg\" onclick=\"open_chat_window(&#39;add_new&#39;)\"><?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<svg width=\"100%\" height=\"100%\" viewbox=\"0 0 43 43\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n    <!-- Generator: Sketch 50.2 (55047) - http://www.bohemiancoding.com/sketch -->\n    <title>times_black<\/title>\n    <desc>Created with Sketch.<\/desc>\n    <defs><\/defs>\n    <g id=\"Page-1\" stroke=\"none\" stroke-width=\"1\" fill=\"none\" fill-rule=\"evenodd\">\n        <g id=\"times_black\" transform=\"translate(21.000000, 22.000000) rotate(45.000000) translate(-21.000000, -22.000000) translate(6.000000, 7.000000)\" fill=\"#979797\" fill-rule=\"nonzero\" stroke=\"#979797\" stroke-width=\"2\">\n            <path d=\"M0.032,0.047 L29.873,29.716\" id=\"Stroke-23\"><\/path>\n            <path d=\"M29.8732,0.047 L0.0322,29.716\" id=\"Stroke-25\"><\/path>\n        <\/g>\n    <\/g>\n<\/svg>\n<\/div><\/div><div class=\"message-people-holder-inner\"><div class=\"message-person\" data-chatroom-is-groups=\"false\" data-chatroomholder-id=\"1061436114\" onclick=\"open_chat_window(1061436114)\" style=\"background-color: #25A9D9\"><div class=\"message-image-wrapper\"><div class=\"message-image\" style=\"border: solid 2px #25A9D9\"><img class=\"pull-left\" src=\"https://s3-us-west-2.amazonaws.com//fortify-production/uploads/user/avatar/1010612042/avatar_1547806601.2416031.png\" alt=\"Avatar 1547806601.2416031\" /><\/div><\/div><div class=\"message-name\">Emma Balogun<\/div><div class=\"badge readornot hidden\"><span class=\"message_count\">0<\/span><\/div><\/div><a href=\"/ally/new\"><div class=\"message-bar-add-ally-container\"><div class=\"message-bar-add-ally centered\">Add Ally<\/div><\/div><\/a><a href=\"/groups\"><div class=\"message-bar-add-ally-container mar-bot10\"><div class=\"message-bar-add-ally centered\">Join a Weekly Group<\/div><\/div><\/a><\/div><\/div><div class=\"message-addon-holder\"><a href=\"/coach/new\"><div class=\"add-coach-message-bar\"><div class=\"add-coach-card\"><div class=\"add-coach-message-container\"><div class=\"add-coach-image-holder pull-left mar-top5\"><?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<svg width=\"30px\" height=\"20px\" viewbox=\"0 0 20 20\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n    <!-- Generator: Sketch 46.1 (44463) - http://www.bohemiancoding.com/sketch -->\n    <title>ic_textsms copy 2<\/title>\n    <desc>Created with Sketch.<\/desc>\n    <defs><\/defs>\n    <g id=\"Side-Nav\" stroke=\"none\" stroke-width=\"1\" fill=\"none\" fill-rule=\"evenodd\">\n        <g id=\"ic_textsms-copy-2\" transform=\"translate(-2.000000, -2.000000)\" fill=\"#FFFFFF\">\n            <path d=\"M20,2 L4,2 C2.9,2 2.01,2.9 2.01,4 L2,22 L6,18 L20,18 C21.1,18 22,17.1 22,16 L22,4 C22,2.9 21.1,2 20,2 L20,2 Z M9,11 L7,11 L7,9 L9,9 L9,11 L9,11 Z M13,11 L11,11 L11,9 L13,9 L13,11 L13,11 Z M17,11 L15,11 L15,9 L17,9 L17,11 L17,11 Z\" id=\"Shape\"><\/path>\n        <\/g>\n    <\/g>\n<\/svg>\n<\/div><div class=\"add-coach-message-bar-text-holder\"><div class=\"add-coach-messages-text\">Message with a Recovery Expert<\/div><div class=\"small-text\">Personal Guidance &amp; Encouragement<\/div><\/div><\/div><\/div><\/div><\/a><\/div><div class=\"message-detail-holder\"><div class=\"messages-baby 1061436114\"><div class=\"card chat_room_container\" data-chat-room-id=\"1061436114\"><div class=\"message-header message-home-view-btn\"><span>Emma Balogun<\/span><i aria-hidden=\"true\" class=\"fa fa-angle-left\" onclick=\"go_back_to_list()\"><\/i><i class=\"fa fa-pencil\" data-function=\"dropdown-menu-wrapper-hover\"><div class=\"small-dropdown-menu-wrapper hidden\"><a onclick=\"overlay_in()\" data-remote=\"true\" href=\"/chat_rooms/1061436114/edit\"><div class=\"small-dropdown-menu-item\">Edit<\/div><\/a><form action=\"/chat_rooms/leave_chat\" accept-charset=\"UTF-8\" data-remote=\"true\" method=\"post\"><input name=\"utf8\" type=\"hidden\" value=\"&#x2713;\" /><input type=\"hidden\" name=\"id\" id=\"id\" value=\"1061436114\" /><input type=\"submit\" name=\"commit\" value=\"Leave Chat\" class=\"small-dropdown-menu-item\" data-confirm=\"Are you sure you want to leave the chat room?\" data-disable-with=\"Leave Chat\" /><\/form><\/div><\/i><\/div><div class=\"messages-holder\" data-scroll=\"-1\"><div class=\"load-more\"><span class=\"load-more-span hidden\">Load past messages<\/span><span class=\"loading\">Loading...<\/span><\/div><div class=\"messages-holder-inner messages-box\"><\/div><\/div><div class=\"card-row small-padding message-form\"><div class=\"row\"><form class=\"new_message\" id=\"new_message\" action=\"#\" accept-charset=\"UTF-8\" method=\"post\"><input name=\"utf8\" type=\"hidden\" value=\"&#x2713;\" /><input type=\"hidden\" name=\"authenticity_token\" value=\"zOwP9Tl8CeLnb5EYmcmThLBcX2iCkvVakol3ak7tGOkaP5/Ql/OPUM8K2xiB0rf4CpGxWWfPg2kst0qayXRyVA==\" /><div><div class=\"message-form-class\"><\/div><div class=\"image-small pull-left mar-lef5\" style=\"border:solid 2px #85DFFF\"><img class=\"img-circle\" src=\"https://s3-us-west-2.amazonaws.com//fortify-production/uploads/user/avatar/1010612036/avatar_1547804677.867454.png\" alt=\"Avatar 1547804677.867454\" /><\/div><div class=\"mar-lef40\"><textarea placeholder=\"Write a message\" class=\"chats_input\" name=\"message[body]\" id=\"message_body\">\n<\/textarea><div class=\"send-message-btn clearfix\"><input type=\"submit\" name=\"commit\" value=\"Send\" class=\"button btn-grey pull-right\" disabled=\"disabled\" data-disable-with=\"Send\" /><\/div><div><div class=\"send-message-toggle\"><input type=\"checkbox\" name=\"enter_d9185bd96fcf6fbf6dca\" id=\"enter_d9185bd96fcf6fbf6dca\" value=\"1\" class=\"cmn-toggle cmn-toggle-round\" checked=\"checked\" /><label for=\"enter_d9185bd96fcf6fbf6dca\">Enter d9185bd96fcf6fbf6dca<\/label><script>$(\'.message-form label\').html(\'\').unbind().click(function(){\n  if($(this).closest(\'form\').find(\'input[type=checkbox]\').is(\':checked\') == true){\n    $(this).closest(\'form\').find(\'input[type=submit]\').removeClass(\'btn-grey\').addClass(\'btn-blue\').prop( \"disabled\", false );;\n  }\n  else{\n    $(this).closest(\'form\').find(\'input[type=submit]\').addClass(\'btn-grey\').removeClass(\'btn-blue\').prop( \"disabled\", true );;\n  }\n});<\/script><\/div><div class=\"send-message-toggle-text\">Press Enter To Send<\/div><\/div><script>$(\'.send-message-toggle label\').html(\'\').unbind().click(function(){\n  if($(this).closest(\'form\').find(\'input[type=checkbox]\').is(\':checked\') == true){\n    $(this).closest(\'form\').find(\'input[type=submit]\').removeClass(\'btn-grey\').addClass(\'btn-blue\').prop( \"disabled\", false );;\n\n  }\n  else{\n    $(this).closest(\'form\').find(\'input[type=submit]\').addClass(\'btn-grey\').removeClass(\'btn-blue\').prop( \"disabled\", true );;\n  }\n});\n\n$(\'.chats_input\').on(\'keydown\', function(e) {\n  if (e.which == 13) {\n    if($(this).val() != \"\" && $(this).closest(\'form\').find(\'input[type=checkbox]\').is(\":checked\") == true){\n      $(this).closest(\'form\').submit();\n      e.preventDefault();\n      $(this).val(\"\");\n    }\n  }\n});\n\n$(\'.message-form input[type=submit]\').click(function(e){\n  target_form = $(this).closest(\'form\')\n  setTimeout(function(){\n    target_form.find(\'textarea\').val(\'\');\n  }, 500);\n})<\/script><\/div><span class=\"input-group-btn\"><\/span><\/div><\/form><script>function resizeTextArea (element) {\n  element.style.height = (element.scrollHeight)+\"px\";\n  var sidebarHeight = $(\'.message-detail-holder\').height();\n  var headerHeight = $(\'.message-header\').outerHeight();\n  var formHeight = $(\'.message-form\').height();\n  var holderHeight = sidebarHeight - headerHeight - formHeight -10;\n  $(\'.messages-holder\').height(holderHeight);\n};<\/script><\/div><\/div><\/div><\/div><div class=\"messages-baby add_new\"><div class=\"card chat_room_container\" data-chat-room-id=\"add_new\"><div class=\"message-header message-home-view-btn\"><span>New Message<\/span><i aria-hidden=\"true\" class=\"fa fa-angle-left\" onclick=\"go_back_to_list()\"><\/i><\/div><div class=\"messages-holder new-message-container\" data-scroll=\"-1\"><div class=\"messages-holder-inner messages-box\"><form action=\"/chat_rooms/create_custom\" accept-charset=\"UTF-8\" data-remote=\"true\" method=\"post\"><input name=\"utf8\" type=\"hidden\" value=\"&#x2713;\" /><div class=\"chatable-title\"><span>Group Name<\/span><input type=\"text\" name=\"title\" id=\"title\" placeholder=\"Add a name\" /><\/div><div class=\"chatable-title\"><span>To:<\/span><span id=\"members-to-add\"><\/span><\/div><div class=\"chatable-user\"><div class=\"chatable-user-image\" style=\"border: solid 1px #85DFFF\"><img src=\"https://s3-us-west-2.amazonaws.com//fortify-production/uploads/user/avatar/1010612042/avatar_1547806601.2416031.png\" alt=\"Avatar 1547806601.2416031\" /><\/div><div class=\"chatable-user-name\">Emma Balogun<\/div><div class=\"chatable-user-check-fake\" data-name=\"Emma Balogun\" onclick=\"toggle_check_from_wrapper(this)\"><input type=\"checkbox\" name=\"user_ids[]\" id=\"user_ids_\" value=\"1010612042\" class=\"hidden\" /><\/div><\/div><input type=\"submit\" name=\"commit\" value=\"Create\" class=\"button btn-blue pull-right\" id=\"create-custom-chat\" onclick=\"overlay_in()\" data-disable-with=\"Create\" /><\/form><\/div><\/div><\/div><\/div><script>function toggle_check_from_wrapper(target_element){\n  $(target_element).toggleClass(\'selected\');\n  if($(target_element).hasClass(\'selected\')){\n    $(target_element).find(\'input[type=checkbox]\').prop(\'checked\',true)\n  }\n  else{\n    $(target_element).find(\'input[type=checkbox]\').prop(\'checked\',false)\n  }\n  list_of_names = \'\'\n  $(\'.chatable-user-check-fake input[type=checkbox]:checked\').each(function(){\n    name = $(this).closest(\'[data-name]\').attr(\'data-name\')\n    list_of_names += \'<div class=\"users-to-add-name-container\">\' + name + \'<\/div>\'\n  })\n  $(\'#members-to-add\').html(list_of_names)\n\n}<\/script><div class=\"messages-baby edit-chat-room\" data-entity=\"edit-chat-room\"><\/div><\/div><\/div><div class=\"exit-msg\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<svg width=\"100%\" height=\"100%\" viewbox=\"0 0 32 32\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n    <!-- Generator: Sketch 39.1 (31720) - http://www.bohemiancoding.com/sketch -->\n    <title>Artboard-1<\/title>\n    <desc>Created with Sketch.<\/desc>\n    <defs><\/defs>\n    <g id=\"Page-1\" stroke=\"none\" stroke-width=\"1\" fill=\"none\" fill-rule=\"evenodd\">\n        <g id=\"Group-48\" transform=\"translate(-229.000000, 1.000000)\" stroke-width=\"2\" stroke=\"#979797\" fill=\"#979797\">\n            <g id=\"Group-47\" transform=\"translate(230.000000, 0.000000)\">\n                <g id=\"times_black\">\n                    <g id=\"Icon\">\n                        <g id=\"Page-1\">\n                            <g id=\"Artboard-1\">\n                                <g id=\"Icon\">\n                                    <path d=\"M0.032,0.047 L29.873,29.716\" id=\"Stroke-23\"><\/path>\n                                    <path d=\"M29.8732,0.047 L0.0322,29.716\" id=\"Stroke-25\"><\/path>\n                                <\/g>\n                            <\/g>\n                        <\/g>\n                    <\/g>\n                <\/g>\n            <\/g>\n        <\/g>\n    <\/g>\n<\/svg>\n<\/div><a data-no-turbolink=\"true\" href=\"/messages\"><div class=\"enlarge-msg\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<svg width=\"100%\" height=\"100%\" viewbox=\"0 0 17 17\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n    <!-- Generator: Sketch 39.1 (31720) - http://www.bohemiancoding.com/sketch -->\n    <defs><\/defs>\n    <g id=\"Symbols\" stroke=\"none\" stroke-width=\"1\" fill=\"none\" fill-rule=\"evenodd\">\n        <g id=\"Group-89-Copy-7\" transform=\"translate(0.000000, 1.000000)\" stroke=\"#979797\">\n            <g>\n                <polyline id=\"Path-6\" points=\"0.763329293 8.57142857 0.763329293 0 9.33475786 0\"><\/polyline>\n                <path d=\"M0.763329293,0 L9.33475786,8.57142857\" id=\"Path-7\"><\/path>\n                <polyline id=\"Path-8\" points=\"2.90618644 10.7142857 2.90618644 15 15.7633293 15 15.7633293 2.14285714 11.477615 2.14285714\"><\/polyline>\n            <\/g>\n        <\/g>\n    <\/g>\n<\/svg>\n<\/div><\/a><script>run_message_init();\n\nfunction run_message_init(){\n  console.log(\"message init!\")\n  chat_room_containers = $(\'.chat_room_container\')\n  if (App.cable.subscriptions[\'subscriptions\'].length > 0){\n    for(i=App.cable.subscriptions[\'subscriptions\'].length-1;i>=0;i--){\n      App.cable.subscriptions.remove(App.cable.subscriptions[\'subscriptions\'][i])\n      if (i == 0){\n        setTimeout(function(){\n          connect_messages();\n        }, 1000);\n      }\n    }\n  }\n  else{\n    connect_messages();\n  }\n\n  function connect_messages(){\n    disable_text_areas()\n    if (chat_room_containers.length > 0){\n      $(\'.chat_room_container\').unbind();\n      $(\'.chat_room_container\').each(function(){\n        container = $(this);\n        App.global_chat = App.cable.subscriptions.create(\n          {\n            channel: \"ChatRoomsChannel\",\n            chat_room_id: container.data(\'chat-room-id\')\n          },\n          {\n            connected: function(data) {\n              // Called when there\'s incoming data on the WebSocket for this channel.\n              // Update the page with the newest broadcast data.\n              console.log(\'connected\')\n              activate_text_areas()\n            },\n\n            disconnected: function(data) {\n              // Called when there\'s incoming data on the WebSocket for this channel.\n              // Update the page with the newest broadcast data.\n              console.log(\'disconnected\')\n              disable_text_areas()\n            },\n\n            received: function(data) {\n              console.log(\"received messages init\")\n              if (data[\'method\'] == \'update\') {\n                $(\'.message-row[data-message-id=\' + data[\'message_id\'] + \']\').find(\'.message-body\').html(data[\'message_body\'])\n              }\n              else if (data[\'method\'] == \'destroy\') {\n                destroy_message_broadcast(data[\'message_id\'])\n              }\n              else{\n                //room_id = $(data[\'message\']).attr(\'data-message-chat-room-id\')\n                room_id = data[\'chat_room_id\']\n                reorder_chat(room_id)\n                target_divs = $(\"[data-chat-room-id=\" + room_id + \"]\").find(\'.messages-holder-inner\');\n                target_divs.each(function(){\n                  $(this).append(message_div({\n                    message_id: data[\'message_id\'],\n                    sender_id: data[\'sender_id\'],\n                    receiver_id: data[\'receiver_id\'],\n                    chat_room_id: data[\'chat_room_id\'],\n                    data_time: data[\'data_time\'],\n                    data_day: data[\'data_day\'],\n                    message: data[\'message\'],\n                    sender_color: data[\'sender_color\'],\n                    sender_points: data[\'sender_points\'],\n                    video: data[\'video\'],\n                    video_thumb: data[\'video_thumb\'],\n                    sender_name: data[\'sender_name\'],\n                    sender_image: data[\'sender_image\'],\n                    message_created_at_in_utc: data[\'message_created_at_in_utc\']\n                  }))\n                  clean_message_ui()\n                  $(this).closest(\'.messages-holder\').scrollTop($(this).height())\n                  if ($(\'html\').attr(\'data-messageroom-page-id\') != room_id){\n                    $(\'.message-person[data-chatroomholder-id=\'+room_id+\']\').find(\'.message_count\').html(parseInt($(\'.message-person[data-chatroomholder-id=\'+room_id+\']\').find(\'.message_count\').html()) + 1)\n                    $(\'.message-person[data-chatroomholder-id=\'+room_id+\']\').find(\'.badge\').addClass(\'pinkbg\').removeClass(\'hidden\')\n                  }\n                });\n\n                if ($(\'html\').attr(\'data-messageroom-page-id\') != room_id){\n                  check_new_message();\n                }\n                else{\n                  $(\'[data-chatroomholder-id=\' + room_id + \']\').click();\n                }\n\n                append_settings(data[\'message_id\'], data[\'sender_id\']);\n\n              }\n            },\n\n            send_message: function(message, chat_room_id, receiver_id) {\n              return this.perform(\'send_message\', {\n                message: message,\n                chat_room_id: chat_room_id,\n                receiver_id: receiver_id,\n                sender_id: \"1010612036\",\n                session_token: \"Ni9GnpHnwvTszvYGY-4h\"\n              });\n\n            }\n          }\n        );\n      })\n\n      $(\'.message-form-class\').closest(\'#new_message\').unbind();\n      $(\'.message-form-class\').closest(\'#new_message\').on(\'submit\', function(e){\n        textarea = $(this).find(\'#message_body\')\n        room_id = $(this).closest(\'.chat_room_container\').data(\'chat-room-id\')\n        if ($.trim(textarea.val()).length > 0){\n          App.global_chat.send_message(removeTags(textarea.val()), room_id, $(this).find(\'.receiver_input\').val())\n          textarea.val(\'\')\n        }\n        e.preventDefault();\n        return false\n      })\n    }\n\n  }\n}\n\n$(\'.load-more-span\').click(function(){\n  load_messages($(this));\n  $(this).addClass(\'hidden\');\n  $(this).closest(\'.load-more\').find(\'.loading\').removeClass(\'hidden\');\n})\n\nfunction load_messages(target_element){\n  first_message_id = target_element.closest(\'.messages-holder\').find(\'.message-row\').first().attr(\'data-message-id\');\n  chat_room_id = target_element.closest(\'.chat_room_container\').attr(\'data-chat-room-id\');\n  $.ajax({\n    url: Routes.load_more_messages_chat_room_path( chat_room_id ),\n    type: \"get\",\n    datatype: \"js\",\n    data: {first_message_id: first_message_id},\n    success: function(data){\n      //handled in the .js.erb\n    },\n    error: function(data){\n      show_ajax_alert(\"There was a problem. Please contact the admin if the problem persists.\");\n    }\n  });\n}\n\nfunction destroy_message_broadcast(message_id){\n  target_row = $(\'.message-row[data-message-id=\' + message_id + \']\')\n  target_row.slideUp();\n  if(target_row.find(\'.message-row-details\').hasClass(\'hidden\')==false){\n    if (target_row.next().hasClass(\'message-row\')){\n      next_row = target_row.next();\n    }\n    else{\n      next_row = target_row.next().next();\n    }\n\n    if(next_row.find(\'.message-row-details\').hasClass(\'hidden\')){\n      if(target_row.next().hasClass(\'message-row\')){\n        target_row.next().find(\'.message-row-image\').removeClass(\'hidden\');\n        target_row.next().find(\'.message-row-details\').removeClass(\'hidden\');\n        target_row.next().find(\'.mar-top-18\').removeClass(\'mar-top-18\');\n\n      }\n      else{\n        target_row.next().next().find(\'.message-row-image\').removeClass(\'hidden\');\n        target_row.next().next().find(\'.message-row-details\').removeClass(\'hidden\');\n        target_row.next().next().find(\'.mar-top-18\').removeClass(\'mar-top-18\');\n      }\n    }\n  }\n  setTimeout(function(){\n    target_row.remove();\n  }, 1000);\n}\n\nfunction message_div(params){\n  //console.log(\"message_div for Joeys test\")\n  //console.log(params)\n  //console.log(params[\'video\'])\n  //console.log(params[\'video_thumb\'])\n  //console.log(params[\'video_thumb\'] === null)\n  if(params[\'video_thumb\'] === null){\n    return (\'<div class=\"card-row message-row message-row-data time-data-before-change\" data-day=\"\' + params[\'data_day\'] + \'\" data-message-chat-room-id=\"\' + params[\'chat_room_id\'] + \'\" data-message-id=\"\' + params[\'message_id\'] + \'\" data-sender=\"\' + params[\'sender_id\'] + \'\" data-time=\"\' + params[\'data_time\'] + \'\">\\\n            <div class=\"message-row-inner\">\\\n              <div class=\"message-row-image message-hide\" style=\"border:solid 2px \' + params[\'sender_color\'] + \'\">\\\n                <img class=\"img-circle\" src=\"\' + params[\'sender_image\'] + \'\" alt=\"Avatar 1500477195.6257865\">\\\n              <\/div>\\\n              <div class=\"message-mar\">\\\n                <div class=\"message-row-details message-hide\">\\\n                  <span class=\"message-row-username\">\' + params[\'sender_name\'] + \'<\/span>\\\n                  <div class=\"user_stats\" style=\"display:inline-block\">\\\n                    <div class=\"pill\" style=\"background-color:\' + params[\'sender_color\'] + \'\">\' + params[\'sender_points\'] + \'<\/div>\\\n                  <\/div>\\\n                  <span class=\"time-stamp time-before-change\">\' + params[\'message_created_at_in_utc\'] + \'<\/span>\\\n                <\/div>\\\n                <div class=\"message-row-body\">\\\n                  <div class=\"message-body\">\\\n                    <p>\' +  simpleFormat2(removeTags(params[\'message\'])) + \'<\/p>\\\n                  <\/div>\\\n                <\/div>\\\n              <\/div>\\\n            <\/div>\\\n            <div class=\"divider-row different-date before-change\" style=\"display: block;\">\\\n              <span>\' + params[\'message_created_at_in_utc\'] + \'<\/span>\\\n            <\/div>\\\n           <\/div>\')\n  }\n  else{\n    return (\'<div class=\"card-row message-row message-row-data time-data-before-change\" data-day=\"\' + params[\'data_day\'] + \'\" data-message-chat-room-id=\"\' + params[\'chat_room_id\'] + \'\" data-message-id=\"\' + params[\'message_id\'] + \'\" data-sender=\"\' + params[\'sender_id\'] + \'\" data-time=\"\' + params[\'data_time\'] + \'\">\\\n      <div class=\"message-row-inner\">\\\n        <div class=\"message-row-image message-hide\" style=\"border:solid 2px \' + params[\'sender_color\'] + \'\">\\\n          <img class=\"img-circle\" src=\"\' + params[\'sender_image\'] + \'\" alt=\"Avatar 1500477195.6257865\">\\\n        <\/div>\\\n        <div class=\"message-mar\">\\\n          <div class=\"message-row-details message-hide\">\\\n            <span class=\"message-row-username\">\' + params[\'sender_name\'] + \'<\/span>\\\n            <div class=\"user_stats\" style=\"display:inline-block\">\\\n              <div class=\"pill\" style=\"background-color:\' + params[\'sender_color\'] + \'\">\' + params[\'sender_points\'] + \'<\/div>\\\n            <\/div>\\\n            <span class=\"time-stamp time-before-change\">\' + params[\'message_created_at_in_utc\'] + \'<\/span>\\\n          <\/div>\\\n          <div class=\"message-row-body\">\\\n            <div class=\"message-body\" onclick=\"play_video_message(\' + params[\'message_id\'] + \')\">\\\n              <div class=\"video-thumb-wrapper\">\\\n                <img class=\"video-message-thumb\" src=\' + params[\'video_thumb\'] + \'>\\\n                <div class=\"video-message-play\"><\/div>\\\n              <\/div>\\\n            <\/div>\\\n          <\/div>\\\n        <\/div>\\\n      <\/div>\\\n      <div class=\"divider-row different-date before-change\" style=\"display: block;\">\\\n        <span>\' + params[\'message_created_at_in_utc\'] + \'<\/span>\\\n      <\/div>\\\n     <\/div>\')\n  }\n}\n\nfunction clean_message_ui(){\n  time = $(\'.time-before-change\').html();\n  newtime = moment(time).format(\'LT\');\n  //newtime = moment(time).add(time_offset,\'hours\').format(\'LT\');\n  $(\'.time-before-change\').html(newtime);\n  $(\'.time-before-change\').removeClass(\'time-before-change\');\n\n  // For divider\n  time_for_divider = $(\'.different-date.before-change span\').html();\n  newtime_for_divider = moment(time_for_divider).add(time_offset,\'seconds\').format(\'MMM DD, YYYY\');\n  $(\'.different-date.before-change span\').html(newtime_for_divider);\n  $(\'.different-date.before-change\').removeClass(\'before-change\')\n\n  // For data-day\n  time_for_data_day = $(\'.time-data-before-change\').attr(\'data-day\');\n  newtime_for_data_day = moment(time_for_data_day).add(time_offset,\'seconds\').format(\'MMM DD, YYYY\');\n  $(\'.time-data-before-change\').attr(\'data-day\', newtime_for_data_day);\n  $(\'.time-data-before-change\').removeClass(\'time-data-before-change\')\n\n  curr_row = $(\'.message-row-data\').closest(\'.messages-holder\').find(\'.card-row\').last();\n  curr_sender_id = curr_row.attr(\'data-sender\');\n  curr_time = curr_row.attr(\'data-time\');\n  curr_day = curr_row.attr(\'data-day\');\n  prev_row = $(\'.message-row-data\').closest(\'.messages-holder\').find(\'.card-row\').last().prev();\n  prev_sender_id = prev_row.attr(\'data-sender\');\n  prev_time = prev_row.attr(\'data-time\');\n  prev_day = prev_row.attr(\'data-day\');\n\n  $(\'.different-date\').hide();\n\n  if (curr_day != prev_day){\n    $(\'.different-date\').show();\n    $(\'.different-date\').closest(\'.card-row\').find(\'.message-row-inner\').addClass(\'mar-top15\');\n  }\n\n  else if (prev_sender_id == curr_sender_id && parseInt(curr_time) < parseInt(prev_time) + 60){\n    $(\'.message-hide\').addClass(\'hidden\');\n    $(\'.message-mar\').addClass(\'mar-top-18\');\n  }\n\n  $(\'.message-hide\').removeClass(\'message-hide\');\n  $(\'.message-mar\').removeClass(\'message-mar\');\n  $(\'.different-date\').removeClass(\'different-date\');\n  $(\'.message-row-data\').removeClass(\'message-row-data\');\n}\n\n//ui functions\n\nfunction disable_text_areas(){\n  $(\'.chats_input\').css(\'background-color\', \'#dee1e2\').attr(\'placeholder\',\'Trying to Connect...\').prop(\'disabled\',true)\n}\nfunction disable_text_areas_due_to_subscription(){\n  $(\'.chats_input\').css(\'background-color\', \'#dee1e2\').attr(\'placeholder\',\'Please update your subscription to message...\').prop(\'disabled\',true)\n}\nfunction activate_text_areas(){\n  $(\'.chats_input\').css(\'background-color\', \'white\').attr(\'placeholder\',\'Write a Message\').prop(\'disabled\',false)\n}\n\nfunction append_settings(message_id, sender_id){\n  if (sender_id == \"1010612036\"){\n    $(\'.message-row[data-message-id=\' + message_id + \']\').find(\'.message-row-body\').addClass(\'my-message\').append(\'<span class=\"message-settings greyed\"><i aria-hidden=\"true\" class=\"fa fa-cog settings-toggle\"><\/i><div class=\"settings-box hidden\"><a data-method=\"delete\" data-remote=\"true\" data-confirm=\"Are you sure?\" href=\"/messages/\' + message_id + \'\"><div class=\"setting-items redded\">Remove<\/div><\/a><a data-remote=\"true\" href=\"/messages/\' + message_id + \'/edit\"><div class=\"setting-items\">Edit<\/div><\/a><\/div><\/span>\')\n  }\n}\n\nfunction play_video_message(message_id){\n  overlay_in()\n  $.ajax({\n    url: Routes.play_video_message_path( message_id ) + \".js\",\n    type: \"get\",\n    success: function(data){\n      //handled in the .js.erb\n    },\n    error: function(data){\n      show_ajax_alert(\"There was a problem. Please contact the admin if the problem persists.\");\n    }\n  });\n}\n\nfunction reorder_chat(room_id){\n  target_chat = $(\".message-person[data-chatroomholder-id=\" + room_id + \"]\")\n  $(\'.message-people-holder-inner\').prepend(target_chat)\n}\n\nfunction go_back_to_list(){\n  $(\'html\').toggleClass(\'message-detail-view-mode\');\n  $(\'html\').attr(\'data-messageroom-page-id\',\'\');\n  $(\'html\').attr(\'data-messageroom-id\',\'home\');\n}\n\n$(document).on(\'click\', \'.settings-toggle\', function(){\n  $(this).parent().find(\'.settings-box\').removeClass(\'hidden\')\n})\n\n$(document).on({\n  mouseenter: function(){\n    $(this).parent().find(\'.settings-box\').removeClass(\'hidden\')\n  },\n  mouseleave: function(){\n    $(this).parent().find(\'.settings-box\').addClass(\'hidden\')\n  }\n}, \'.settings-toggle\');\n\n$(document).on({\n  mouseenter: function(){\n    $(this).parent().find(\'.settings-box\').removeClass(\'hidden\')\n  },\n  mouseleave: function(){\n    $(this).parent().find(\'.settings-box\').addClass(\'hidden\')\n  }\n}, \'.settings-box\');\n\nfunction open_messagebar(chat_room_id){\n  $(\'html\').addClass(\'message-active\');\n  $(\'.message-person[data-chatroomholder-id=\' + chat_room_id + \']\').click()\n  dynamically_change_sizes();\n}\n\nfunction open_chat_window(chat_room_id){\n  console.log(\'open_chat_window\')\n  open_messagebar()\n  target_element = $(\'.message-person[data-chatroomholder-id=\' + chat_room_id + \']\')\n\n  $(\'#message .message-person\').toggleClass(\"user-active\", false);\n  $(target_element).toggleClass(\"user-active\", true);\n\n  $(\'.messages-baby\').addClass(\"hidden\");\n  $(\'.messages-baby.\'+chat_room_id).removeClass(\"hidden\");\n  $(\'html\').attr(\'data-messageroom-page-id\', chat_room_id)\n  $(\'html\').addClass(\'message-detail-view-mode\');\n  $(\'html\').attr(\'data-messageroom-id\',$(this).attr(\'data-id\'));\n\n  if(chat_room_id != \'add_new\' && chat_room_id != \'edit-chat-room\'){\n    //load more messages\n    if (target_element.hasClass(\'ajaxed\')){\n      //do nothing\n    }\n    else {\n      target_element.addClass(\'ajaxed\');\n      load_messages($(\'.messages-baby.\'+chat_room_id).find(\'.load-more-span\'));\n    }\n    //read\n    $.post( Routes.read_messages_chat_room_path(chat_room_id), function(data){});\n    //update ui\n    $(target_element).find(\'.readornot\').removeClass(\'pinkbg\');\n    $(target_element).find(\'.readornot\').addClass(\'hidden\')\n    $(target_element).find(\'.message_count\').html(\"0\");\n\n    check_new_message()\n  }\n}\n\nfunction chat_find_or_create(target_element){\n  if($(target_element).attr(\'data-chatroom-id\') != \"\"){\n    console.log(\'chat_find_or_create : find\')\n    chat_room_id = $(target_element).attr(\'data-chatroom-id\')\n    open_chat_window(chat_room_id)\n  }\n  else{\n    console.log(\'chat_find_or_create : create\')\n    create_chat_room([$(target_element).attr(\'data-user-id\')])\n  }\n}\n\nfunction create_chat_room(user_ids){\n  $.ajax({\n    url: Routes.create_custom_chat_rooms_path(),\n    type: \"post\",\n    datatype: \"js\",\n    data: { user_ids: user_ids }\n  })\n}\n\nfunction check_new_message(){\n  // return \"hello\"\n  $(\'.message-incoming\').addClass(\'hidden\');\n  new_message_count = 0;\n  // for messages bar\n  $(\'.message-people-holder\').each(function(){\n    folder_type = $(this).attr(\'data-holder-type\');\n    folder_count = 0;\n    $(this).find(\'.message_count\').each(function(){\n      if($(this).html() != \"0\"){\n        if (isNaN(parseInt($(this).html())) === false){\n          folder_count = folder_count + parseInt($(this).html())\n        }\n        $(this).closest(\'.readornot\').removeClass(\"hidden\")\n      }\n    })\n    if (folder_count > 0){\n      $(\'.message-folder[data-folder=\' + folder_type + \']\').find(\'.readornot\').removeClass(\'hidden\').find(\'.message_count\').html(folder_count);\n      new_message_count = new_message_count + folder_count;\n    }\n    else{\n      $(\'.message-folder[data-folder=\' + folder_type + \']\').find(\'.readornot\').addClass(\'hidden\').find(\'.message_count\').html(\"0\");\n    }\n  })\n\n  if (new_message_count > 0){\n    $(\'.message-incoming\').removeClass(\'hidden\');\n    $(\'.message-incoming\').html(new_message_count);\n  }\n\n  //for messages page\n  $(\'#message_page\').find(\'.message_count\').each(function(){\n    if($(this).html() != \"0\"){\n      if (isNaN(parseInt($(this).html())) === false){\n        new_message_count = new_message_count + parseInt($(this).html())\n      }\n      $(this).closest(\'.readornot\').removeClass(\"hidden\")\n      $(\'.message-incoming\').removeClass(\'hidden\');\n      $(\'.message-incoming\').html(new_message_count);\n    }\n  })\n  $(\'#message_page .message-people-holder\').each(function(){\n    this_folder = $(this);\n    this_folder.find(\'.message-person\').each(function(){\n     if($(this).find(\'.message_count\').html() > 0){\n       $(this).prependTo(this_folder);\n     }\n    });\n  });\n}\n\n$(document).ready(function(){\n\n  // ACTIVATE THE FIRST ELEMENTS IN EACH LIST SO IT\'S NOT BLANK\n  $(\'#message .message-person\').first().toggleClass(\"user-active\", true);\n\n  $(\'.exit-msg\').click(function(){\n    $(\'html\').toggleClass(\'message-active\');\n    dynamically_change_sizes();\n  })\n\n  $(\'.add-coach-message-bar\').click(function(){\n    $(\'html\').toggleClass(\'message-active\');\n    dynamically_change_sizes();\n  })\n\n  $(\'.message-bar-add-ally-container\').click(function(){\n    $(\'html\').toggleClass(\'message-active\');\n    dynamically_change_sizes();\n  })\n\n  // for /messages\n  $(\'#message_page .message-person\').unbind();\n  $(\'html\').attr(\'data-messageroom-page-id\', \"\");\n  $(\'#message_page .message-person\').click(function(){\n    $(\'html\').attr(\'data-messageroom-page-id\',$(this).attr(\'data-id\'));\n  })\n\n})<\/script><div id=\"messagebar-ghost\"><\/div><script>//$(\'#messagebar-ghost\').height\n$(\'.chats_input\').focus(function(){\n  $(\'#messagebar-ghost\').addClass(\'expanded-message-ghost\')\n  apply_height($(this))\n})\n$(\'.chats_input\').focusout(function(){\n  $(\'#messagebar-ghost\').removeClass(\'expanded-message-ghost\')\n  apply_height($(this))\n})\n\n$(\'.chats_input\').on(\'keyup\', function(e) {\n  // clear any existing timer which will exist if the user is actively typing\n  apply_height($(this))\n});\n\nfunction apply_height(this_target){\n  $(\'#messagebar-ghost\').html(removeTags(this_target.val()));\n  current_height = $(\'#messagebar-ghost\').height()\n  if (current_height < 80){\n    current_height = 80;\n  }\n  else if (current_height > 400){\n    current_height = 400;\n  }\n\n  this_target.css(\'height\',(current_height - 18) + \'px\');\n  this_target.closest(\'.message-form\').css(\'height\',(current_height + 40) + \'px\');\n  this_target.closest(\'.messages-baby\').find(\'.messages-holder\').css(\'height\', \'calc(100vh - \' + (this_target.closest(\'.message-form\').height() + 111) + \'px\');\n}<\/script><\/div><script>$(document).ready(function(){\n  addon_height = $(\'#message .message-addon-holder\').height();\n  if(addon_height < 40){ addon_height = 40; }\n  $(\'#message .message-people-holder-inner\').css(\'height\',\'calc(100% - \' + (addon_height) + \'px)\')\n  $(\'#message .message-folders-holder\').css(\'height\',\'calc(100% - \' + (addon_height) + \'px)\')\n\n  check_new_message();\n  $(\'#message .messages-holder\').unbind();\n  $(\'#message .messages-holder\').scroll(function(){\n    $(this).attr(\'data-scroll\',$(this).scrollTop())\n  })\n  $(\'#message .messages-holder\').each(function(){\n    if($(this).attr(\'data-scroll\') != -1){\n      $(this).scrollTop($(this).attr(\'data-scroll\'));\n    }\n    else{\n      $(this).scrollTop($(this).find(\'.messages-holder-inner\').height());\n    }\n  })\n})<\/script>");
